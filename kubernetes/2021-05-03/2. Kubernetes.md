### 0. 설치 전 환경 구성

Swap disabled
```bash
swapoff -a && sed -i '/swap/s/^/#/' /etc/fstab
```

브릿지 네트워크 Listen
```bash
cat <<EOF > /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
EOF
sysctl --system
```

방화벽 해제
 - 앞 단에 따로 구성되니 쿠버네티스에선 해제

```bash
systemctl stop firewalld
systemctl disable firewalld
```


### 1. kubeadm, kubectl, kubelet 설치

```bash
apt-get update && apt-get install -y apt-transport-https ca-certificates curl

curl -fsSLo /usr/share/keyrings/kubernetes-archive-keyring.gpg https://packages.cloud.google.com/apt/doc/apt-key.gpg

echo "deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main" | sudo tee /etc/apt/sources.list.d/kubernetes.list

apt-get update
apt-get install -y kubelet kubeadm kubectl
apt-mark hold kubelet kubeadm **kubectl**
```


```bash
systemctl start kubelet
systemctl enable kubelet
```

### 2. Creating a cluster with kubeadm

To initialize the control-plane node run:
**마스터에서만 해야됨!**
```bash
kubeadm init
```
아래와 같이 나오면 성공. (시간이 좀 걸림)
```bash
Your Kubernetes control-plane has initialized successfully!

To start using your cluster, you need to run the following as a regular user:

  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config

Alternatively, if you are the root user, you can run:

  export KUBECONFIG=/etc/kubernetes/admin.conf

You should now deploy a pod network to the cluster.
Run "kubectl apply -f [podnetwork].yaml" with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

Then you can join any number of worker nodes by running the following on each as root:

kubeadm join 10.0.2.15:6443 --token XXXXXX.XXXXXXXXXXXXXXX \
	--discovery-token-ca-cert-hash sha256:XXXXXXXXXXXXXXX
```

토큰을 **token.txt** 에 저장해두자.
```bash
cat > token.txt

kubeadm join 10.0.2.15:6443 --token XXXXXX.XXXXXXXXXXXXXXX \
	--discovery-token-ca-cert-hash sha256:XXXXXXXXXXXXXXX
```

root가 아닌 일반 유저(regular user)도 kubectl 명령어를 쓸 수 있도록 설정.
```bash
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

이제 kubectl 명령어를 쓸 수 있다.
```bash
kubectl get nodes
```

아래와 같이 나오면 성공.
```bash
NAME                STATUS     ROLES                  AGE     VERSION
master-virtualbox   NotReady   control-plane,master   5m58s   v1.21.0
```

이제 다른 유저에도 설정해준다.
```bash
exit

mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

##### [Go Overview.](https://github.com/es5es5/TIL/tree/main/kubernetes/2021-05-03)
